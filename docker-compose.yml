
services:
  emqx:
    image: emqx:5
    container_name: emqx
    restart: unless-stopped
    ports:
      - "1883:1883"   # MQTT
      - "18083:18083" # Dashboard
    healthcheck:
      test: ["CMD", "sh", "-lc", "nc -z 127.0.0.1 1883"]
      interval: 5s
      timeout: 3s
      retries: 30
    networks: [iot]

  influxdb:
    image: influxdb:2.7
    container_name: influxdb
    restart: unless-stopped
    ports: ["8086:8086"]
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: ${INFLUX_USER}
      DOCKER_INFLUXDB_INIT_PASSWORD: ${INFLUX_PASSWORD}
      DOCKER_INFLUXDB_INIT_ORG: ${INFLUX_ORG}
      DOCKER_INFLUXDB_INIT_BUCKET: ${INFLUX_BUCKET}
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: ${INFLUX_TOKEN}
    volumes:
      - influx-data:/var/lib/influxdb2
    networks: [iot]

  telegraf:
    image: telegraf:1.32
    container_name: telegraf
    restart: unless-stopped
    depends_on:
      emqx:
        condition: service_healthy
      influxdb:
        condition: service_started
    volumes:
      - ./telegraf.conf:/etc/telegraf/telegraf.conf:ro
    env_file: .env
    networks: [iot]

  grafana:
    image: grafana/grafana:12.0.2
    container_name: grafana
    restart: unless-stopped
    depends_on:
      influxdb:
        condition: service_started
    ports:
      - "3004:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
    networks: [iot]

  # ====== OPCUA -> MQTT (BOIL_DRUM_LEVEL) ======
  opcua2mqtt_drum:
    build: .
    container_name: opcua2mqtt_drum
    restart: unless-stopped
    env_file: .env        # Ø¨Ù‚ÛŒÙ‡ Ù…ØªØºÛŒØ±Ù‡Ø§ Ø§Ø² Ø§ÛŒÙ†Ø¬Ø§ Ù…ÛŒâ€ŒØ¢ÛŒÙ†Ø¯
    environment:
      OPCUA_START_PATH: "DA.MODULES.BOILER.BOIL_DRUM_LEVEL"
      MAX_BROWSE_DEPTH: "5"
      BROWSE_DELAY_MS: "100"
      # ØªØ§Ù¾ÛŒÚ©â€ŒÙ‡Ø§ÛŒ Ù…Ø¬Ø²Ø§ Ø¨Ø±Ø§ÛŒ Drum
      TOPIC_BASE: "plant/${SITE}/${UNIT}/${PLC}/cv/drum"
      PUBSUB_TOPIC: "opcua/json/${SITE}-${UNIT}-${PLC}-DRUM"
      PUBLISHER_ID: "${SITE}-${UNIT}-${PLC}-DRUM"
      DATASET_WRITER_ID: "1"
    depends_on:
      emqx:
        condition: service_healthy
    networks: [iot]

  # ====== OPCUA -> MQTT (BOIL_COMB_BURN) ======
  opcua2mqtt_burn:
    build: .
    container_name: opcua2mqtt_burn
    restart: unless-stopped
    env_file: .env
    environment:
      OPCUA_START_PATH: "DA.MODULES.BOILER.BOIL_COMB_BURN"
      MAX_BROWSE_DEPTH: "5"
      BROWSE_DELAY_MS: "100"
      # ØªØ§Ù¾ÛŒÚ©â€ŒÙ‡Ø§ÛŒ Ù…Ø¬Ø²Ø§ Ø¨Ø±Ø§ÛŒ Burn
      TOPIC_BASE: "plant/${SITE}/${UNIT}/${PLC}/cv/burn"
      PUBSUB_TOPIC: "opcua/json/${SITE}-${UNIT}-${PLC}-BURN"
      PUBLISHER_ID: "${SITE}-${UNIT}-${PLC}-BURN"
      DATASET_WRITER_ID: "2"
    depends_on:
      emqx:
        condition: service_healthy
    networks: [iot]



  mqtt-dump:
    image: eclipse-mosquitto:2
    container_name: mqtt-dump
    command:
      - sh
      - -c
      - |
        echo "ðŸ“¡ Subscribing to all topics on EMQX..." && \
        mosquitto_sub -h emqx -p 1883 -t 'plant/#' -v
    depends_on:
      emqx:
        condition: service_healthy
    networks: [iot]
    restart: "no"


volumes:
  influx-data:

networks:
  iot:
    driver: bridge
